<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>AR з marker.mind та геомоделями</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
    }
    #instructions, #status {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-family: sans-serif;
      background: rgba(0, 0, 0, 0.5);
      padding: 8px 12px;
      border-radius: 6px;
      user-select: none;
      z-index: 1;
      color: white;
    }
    #instructions {
      top: 10px;
    }
    #status {
      bottom: 10px;
      color: #0f0;
    }
  </style>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.min.js"></script>
</head>
<body>
  <div id="instructions">Очікуємо позицію... Дозвольте доступ до геолокації та наведіть камеру на marker.mind</div>
  <div id="status"></div>

  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; gpsMinDistance: 1; trackingMethod: best;"
  >
    <!-- GPS-камера -->
    <a-entity gps-camera rotation-reader></a-entity>

    <!-- NFT-маркер -->
    <a-nft
      type="nft"
      url="marker/marker"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5"
      id="mind-marker"
    >
      <!-- Контейнер, в який додамо моделі після геопозиціювання -->
      <a-entity id="model-container"></a-entity>
    </a-nft>

    <!-- Обов’язково: щоб камера запускалася -->
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const R_EARTH = 6378137;
    function metersToLatitudeDegrees(meters) {
      return (meters / R_EARTH) * (180 / Math.PI);
    }
    function metersToLongitudeDegrees(meters, latitude) {
      return (meters / (R_EARTH * Math.cos(latitude * Math.PI / 180))) * (180 / Math.PI);
    }

    function placeModels(lat, lon) {
      const deltaLon = metersToLongitudeDegrees(5, lat);
      const deltaLat = metersToLatitudeDegrees(0);

      const leftLat = lat + deltaLat;
      const leftLon = lon - deltaLon;

      const rightLat = lat + deltaLat;
      const rightLon = lon + deltaLon;

      const container = document.getElementById('model-container');

      const modelLeft = document.createElement('a-entity');
      modelLeft.setAttribute('gps-entity-place', `latitude: ${leftLat}; longitude: ${leftLon}`);
      modelLeft.setAttribute('gltf-model', 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Duck/glTF/Duck.gltf');
      modelLeft.setAttribute('scale', '0.5 0.5 0.5');
      modelLeft.setAttribute('rotation', '0 180 0');
      modelLeft.setAttribute('position', '-1 0 -3');
      container.appendChild(modelLeft);

      const modelRight = document.createElement('a-entity');
      modelRight.setAttribute('gps-entity-place', `latitude: ${rightLat}; longitude: ${rightLon}`);
      modelRight.setAttribute('gltf-model', 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/CesiumMan/glTF/CesiumMan.gltf');
      modelRight.setAttribute('scale', '0.3 0.3 0.3');
      modelRight.setAttribute('rotation', '0 180 0');
      modelRight.setAttribute('position', '1 0 -3');
      container.appendChild(modelRight);

      document.getElementById('instructions').innerText = 'Моделі завантажено після розпізнавання маркера.';
    }

    // Чекаємо на розпізнавання маркера та тоді завантажуємо геомоделі
    document.getElementById('mind-marker').addEventListener('markerFound', () => {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          document.getElementById('status').innerText = `Ваша позиція: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
          placeModels(lat, lon);
        },
        (err) => {
          document.getElementById('status').innerText = 'Помилка геолокації: ' + err.message;
        },
        {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 10000
        }
      );
    });
  </script>
</body>
</html>
